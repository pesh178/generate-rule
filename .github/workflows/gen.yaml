name: generate rule list

on: 
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * 1'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11' 
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - run: python generate_list.py

      - name: Delete .gitkeep file
        run: rm -f generated_rules/.gitkeep

      # --- ğŸ‘‡ æ–°å¢æ­¥éª¤ 1ï¼šä¸‹è½½å¹¶é…ç½® Mihomo å†…æ ¸ ğŸ‘‡ ---
      - name: Setup Mihomo
        run: |
          echo "Fetching latest Mihomo version..."
          # ä½¿ç”¨ API è·å–æœ€æ–° Linux amd64 ç‰ˆæœ¬ä¸‹è½½é“¾æ¥ (æ’é™¤ compatible ç‰ˆæœ¬)
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest \
            | grep "browser_download_url" \
            | grep "linux-amd64-v" \
            | grep ".gz" \
            | head -n 1 \
            | cut -d '"' -f 4)
          
          echo "Downloading from: $DOWNLOAD_URL"
          wget -O mihomo.gz "$DOWNLOAD_URL"
          gzip -d mihomo.gz
          chmod +x mihomo
          ./mihomo -v
      # -----------------------------------------------

      # --- ğŸ‘‡ æ–°å¢æ­¥éª¤ 2ï¼šå°† YAML ç¼–è¯‘ä¸º MRS ğŸ‘‡ ---
      - name: Convert to MRS
        run: |
          echo "Compiling rules to MRS format..."
          # éå†æ‰€æœ‰ç”Ÿæˆçš„ Clash YAML æ–‡ä»¶
          for file in generated_rules/*-clash_reject_hostnames.yaml; do
            if [ -f "$file" ]; then
              filename=$(basename -- "$file")
              name="${filename%.*}"
              # ç¼–è¯‘å‘½ä»¤: convert-ruleset domain yaml <è¾“å…¥> <è¾“å‡º>
              # æ³¨æ„ï¼šè¿™é‡Œå‡è®¾æ‚¨çš„ YAML å†…å®¹æ˜¯ payload åˆ—è¡¨ (domain behavior)
              ./mihomo convert-ruleset domain yaml "$file" "generated_rules/${name}.mrs"
              echo "âœ… Generated: generated_rules/${name}.mrs"
            fi
          done
      # --------------------------------------------
      
      - name: Generate release tag
        id: tag
        run: |
          echo "release_tag=generate_$(date +"%Y.%m.%d_%H-%M")" >> $GITHUB_OUTPUT
          
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          # é€šé…ç¬¦ * ä¼šè‡ªåŠ¨ä¸Šä¼ è¯¥ç›®å½•ä¸‹æ‰€æœ‰çš„ .yaml, .conf å’Œ .mrs æ–‡ä»¶
          files: ./generated_rules/*
          token: ${{ secrets.GITHUB_TOKEN }}
